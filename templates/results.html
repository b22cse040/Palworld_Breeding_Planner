<!doctype html>
<html>
<head>
  <title>Breeding Results</title>
  <style>
    body {
      font-family: system-ui, -apple-system;
      margin: 40px;
      background: #fafafa;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .pal-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .pal-row:last-child { border-bottom: none; }
    .meta { color: #666; }
    dialog {
      border-radius: 10px;
      padding: 20px;
    }
    dialog img { max-width: 100%; }
  </style>
</head>

<body>

<a href="/">‚Üê Back</a>
<h2>Results</h2>

<div style="margin-bottom:12px;">
  Sort results by:
  <select id="resultSort">
    <option value="">(no sorting)</option>
    {% for a in abilities %}
      <option value="{{a}}">{{a}}</option>
    {% endfor %}
  </select>
</div>

{% for depth, items in results.items() %}
<div class="card depth-block">
  <h3>Depth {{ depth }}</h3>

  {% for pal, graph, gid in items %}
    <div class="pal-row"
         {% for a in abilities %}
         data-{{a}}="{{ pal | attr(a) }}"
         {% endfor %}>
      <div>
        <b>{{ pal.name }}</b>
        <span class="meta">
          | unique pals = {{ graph.unique_pal_count() }}
        </span>
        <span class="ability-value"></span>
      </div>
      <button onclick="openDialog('{{gid}}')">Visualize</button>
    </div>
  {% endfor %}
</div>
{% endfor %}

<dialog id="dlg">
  <img id="img">
  <br><br>
  <button onclick="dlg.close()">Close</button>
</dialog>

<script>
const sortSelect = document.getElementById("resultSort");

sortSelect.onchange = () => {
  const ability = sortSelect.value;

  document.querySelectorAll(".depth-block").forEach(block => {
    const rows = Array.from(block.querySelectorAll(".pal-row"));

    rows.forEach(r => {
      const label = r.querySelector(".ability-value");
      label.textContent = ability
        ? `| ${ability} = ${r.dataset[ability]}`
        : "";
    });

    if (!ability) return;

    rows.sort((a, b) =>
      parseInt(b.dataset[ability]) - parseInt(a.dataset[ability])
    );

    rows.forEach(r => block.appendChild(r));
  });
};

function openDialog(id) {
  const img = document.getElementById("img");
  img.src = `/graph/${id}?t=${Date.now()}`;
  dlg.showModal();
}
</script>

</body>
</html>